#!/bin/sh

if [ "x" = "x$3" ]; then
    echo "Usage: $0 template tag 'nic0|10.7.7.x/32'"
    exit 1
fi

if ! which iocage >/dev/null 2>&1 ; then
    echo "ERROR: iocage not found."
    exit 1
fi

TEMPLATE=${1}
JAILNAME=${2}
NICNET="${3}"

. ~/bin/ioc-conf

pf-nat-jails

iocage clone ${TEMPLATE} tag=${JAILNAME} ip4_addr="${NICNET}"
iocage set boot=on ${JAILNAME}

# grep the newly created UUID
UUID=$( iocage list | grep "${JAILNAME}$" | awk '{print $2}' )

if [ ! -e /iocage/jails/${UUID}/root/root ]; then
    echo "ERROR: jail not created."
    exit 1
else
    if [ ! -d /iocage/jails/${UUID}/root/root/local ]; then
        install -d -m 700 \
              /iocage/jails/${UUID}/root/root/local
    fi
    if [ ! -d /iocage/jails/${UUID}/root/root/local ]; then
        echo "ERROR: template /root/local not created."
        exit 1
    else
        if [ -e ~/local/cshvars ]; then
            install -m 600 ~/local/cshvars  /iocage/jails/${UUID}/root/root/local/cshvars
        fi
    fi
fi
