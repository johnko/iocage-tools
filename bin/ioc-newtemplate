#!/bin/sh

if [ "x" = "x$2" ]; then
    echo "Usage: $0 template 'nic0|10.7.7.x/32'"
    exit 1
fi

if ! which iocage >/dev/null 2>&1 ; then
    echo "ERROR: iocage not found."
    exit 1
fi


TEMPLATE=${1}
NICNET="${2}"

. ~/bin/ioc-conf

pf-nat-jails

iocage create -c tag=${TEMPLATE} ip4_addr="${NICNET}"
iocage set boot=on ${TEMPLATE}

# grep the newly created UUID
UUID=$( iocage list | grep "${TEMPLATE}$" | awk '{print $2}' )

if [ ! -e /iocage/jails/${UUID}/root/root ]; then
    echo "ERROR: template not created."
    exit 1
else
    if [ ! -d /iocage/jails/${UUID}/root/root/bin ]; then
        install -d -m 700 \
              /iocage/jails/${UUID}/root/root/bin
    fi
    if [ ! -d /iocage/jails/${UUID}/root/root/bin ]; then
        echo "ERROR: template /root/bin not created."
        exit 1
    else
        ## skip motd on jail console
        touch /iocage/jails/${UUID}/root/root/.hushlogin
        ## install pkg-static
        install -m 755 /usr/local/sbin/pkg-static  /iocage/jails/${UUID}/root/sbin/pkg-static
        ## install etc/files
        for i in $( ls ~/git/iocage-tools/etc ) ; do
            if [ -f ~/git/iocage-tools/etc/${i} ]; then
                install -m 644 ~/git/iocage-tools/etc/${i}  /iocage/jails/${UUID}/root/etc/${i}
            fi
        done

        ## run fres
        install -m 700 ~/bin/fres  /iocage/jails/${UUID}/root/root/bin/fres
        iocage chroot ${UUID} fres

        ## run portsnap
        #install -m 700 ~/bin/psnap /iocage/jails/${UUID}/root/root/bin/psnap
        ##can't run psnap in a chroot because it misses fetching some files
        ##iocage chroot ${UUID} psnap
        ## ask user for help
        iocage start ${UUID}
        cat <<EOF
Please run this:
    setenv HTTP_PROXY ${HTTP_PROXY}
    psnap ; exit
EOF
        iocage console ${UUID}

        ## stop jail
        iocage stop ${UUID}
        iocage set notes="template based on ${RELEASE} with pkg-static, fres, psnap" ${UUID}
        iocage set template=yes ${UUID}
        if ! iocage list -t | grep "${UUID}" >/dev/null 2>/dev/null ; then
            echo "ERROR: template not converted from jail."
            exit 1
        fi
    fi
fi
