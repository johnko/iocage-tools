#!/bin/sh


TEMPLATE=${1}
NICNET="${2}"

pf-nat-jails

iocage create -c tag=${TEMPLATE} ip4_addr="${NICNET}"
iocage set boot=on ${TEMPLATE}

# grep the newly created UUID
UUID=$( iocage list | grep "${TEMPLATE}$" | awk '{print $2}' )

if [ ! -e /iocage/jails/${UUID}/root/root ]; then
    echo "ERROR: template not created."
    exit 1
else
    if [ ! -d /iocage/jails/${UUID}/root/root/bin ]; then
        install -d -m 700 \
              /iocage/jails/${UUID}/root/root/bin
    fi
    if [ ! -d /iocage/jails/${UUID}/root/root/bin ]; then
        echo "ERROR: template /root/bin not created."
        exit 1
    else
        ## run fres
        install -m 700 ~/bin/fres  /iocage/jails/${UUID}/root/root/bin/fres
        iocage chroot ${UUID} fres
        ## run portsnap
        #install -m 700 ~/bin/psnap /iocage/jails/${UUID}/root/root/bin/psnap
        iocage chroot ${UUID} psnap
        # stop jail
        iocage stop ${UUID}
        iocage set template=yes ${UUID}
        if ! iocage list -t | grep "${UUID}" >/dev/null 2>/dev/null ; then
            echo "ERROR: template not converted from jail."
            exit 1
        fi
    fi
fi
